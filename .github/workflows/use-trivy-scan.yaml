on:
  workflow_call:
    inputs:
      deployment-name:
        required: false
        type: string
    

jobs:
  images:
    name: üì¶ List Docker Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: "manifests-${{ inputs.deployment-name }}.yaml"
      
      # - uses: socialgouv/workflows/actions/manifests-images@v1
      - uses: socialgouv/workflows/actions/manifests-images@feat/trivy-scan
        id: manifests-images

  trivy-scan:
    name: üïµÔ∏è Trivy scan
    needs: [images]
    runs-on: ubuntu-latest
    # environment: review-auto
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        imageRef: ${{ fromJson(needs.images.manifests-images.images) }}
    steps:
      # - uses: socialgouv/workflows/actions/trivy-scan-image@v1
      - uses: socialgouv/workflows/actions/trivy-scan-image@feat/trivy-scan
        with:
          image: ${{ matrix.imageRef }}
          token: ${{ secrets.GITHUB_TOKEN }}
